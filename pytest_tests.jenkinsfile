pipeline {
    agent any

    stages {
        stage('Prepare workspace') {
            steps {
               echo "Start installing dependencies"
               sh "pip install -r requirements.txt"
            }
        }
        stage('Run tests') {
            steps {
                script {
                    echo "Start running test cases"
                    def test_results = sh (script: "pytest trn_db_tests.py -v", returnStatus: true)
                    echo "Status code of tests execution: ${test_results}"
                }
            }
        }
        stage('Merge to production') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'rf_user', usernameVariable: 'Username', passwordVariable: 'Password')]) {
                    echo "Merging..."
                    sh '''
                        git checkout production
                        git merge origin/add_jenkinsfile
                    '''
                }
            }
        }
    }
}